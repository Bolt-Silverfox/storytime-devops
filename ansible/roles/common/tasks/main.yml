---
# Common role - Install system dependencies and setup SSH key

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install common dependencies
  apt:
    name:
      - git
      - curl
      - wget
      - build-essential
      - python3
      - python3-pip
      - software-properties-common
      - ufw
      - unzip
    state: present

- name: Install Node.js 20.x
  shell: |
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    apt-get install -y nodejs
  args:
    creates: /usr/bin/node

- name: Verify Node.js installation
  command: node --version
  register: node_version
  changed_when: false

- name: Display Node.js version
  debug:
    msg: "Node.js version: {{ node_version.stdout }}"

- name: Install pnpm globally
  npm:
    name: pnpm
    global: yes
    state: present

- name: Verify pnpm installation
  command: pnpm --version
  register: pnpm_version
  changed_when: false

- name: Display pnpm version
  debug:
    msg: "pnpm version: {{ pnpm_version.stdout }}"

- name: Install PM2 globally
  npm:
    name: pm2
    global: yes
    state: present

- name: Setup PM2 to start on boot
  shell: |
    pm2 startup systemd -u {{ ansible_user }} --hp /home/{{ ansible_user }}
    pm2 save
  args:
    creates: /etc/systemd/system/pm2-{{ ansible_user }}.service

- name: Ensure .ssh directory exists
  file:
    path: "/home/{{ ansible_user }}/.ssh"
    state: directory
    mode: '0700'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Deploy SSH private key from vault
  copy:
    content: "{{ vault_deployment_key }}"
    dest: "/home/{{ ansible_user }}/.ssh/deployment_key"
    mode: '0600'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Add GitHub to known hosts
  known_hosts:
    name: github.com
    key: "{{ lookup('pipe', 'ssh-keyscan -t rsa github.com') }}"
    state: present
    path: "/home/{{ ansible_user }}/.ssh/known_hosts"

- name: Configure SSH for private repositories
  blockinfile:
    path: "/home/{{ ansible_user }}/.ssh/config"
    create: yes
    mode: '0600'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    block: |
      Host github.com
        HostName github.com
        User git
        IdentityFile ~/.ssh/deployment_key
        StrictHostKeyChecking no
        UserKnownHostsFile /dev/null

- name: Configure UFW firewall
  ufw:
    rule: allow
    port: "{{ item }}"
  loop:
    - "22"
    - "80"
    - "443"

- name: Enable UFW
  ufw:
    state: enabled
